### 运行指南

1.在pycharm中配置终端及解释器

2.在终端中依次输入

```
#确保在当前工作目录下
cd <current work path>

#运行程序，并自定义参数（若示例IP地址ping不通，可以尝试选择其他的）
python ping.py --host www.baidu.com --timeout 2 --count 5 
```

### 核心功能和代码逻辑说明

这段代码的主要功能是通过 ICMP 协议实现一个类似 `ping` 的工具，测量目标主机的网络延迟，并收集多次 ping 操作的统计数据，如最小、最大、平均往返时间 (RTT) 和丢包率。

ICMP（Internet Control Message Protocol）用于在网络中传递控制信息，例如，主机是否可达，响应时间等。`ping` 工具通过发送 ICMP Echo Request 报文，接收目标主机返回的 ICMP Echo Reply 报文来判断网络连通性并计算延迟。

### 代码主要逻辑和功能说明

1. **导入依赖库**:
   - `socket`: 用于创建套接字并发送和接收 ICMP 数据包。
   - `struct`: 用于打包和解包数据，ICMP 报头和数据的构造需要这个模块。
   - `time`: 用于记录发送和接收数据包的时间戳，计算延迟。
   - `os`: 用于获取当前进程 ID，作为 ICMP 数据包的标识符。
   - `argparse`: 用于处理命令行参数，支持动态指定目标地址、ping 次数和超时时间等参数。

2. **校验和计算 (`calculate_checksum`)**:
   - ICMP 数据包中的校验和用于数据的完整性检查。ICMP 协议要求发送的数据包和接收的数据包在传输过程中保持一致。
   - 校验和的计算是通过将数据包中的所有 16 位数据加起来，然后取反得到的。每次发送的 ICMP 数据包需要先通过该函数计算出校验和，确保数据包的完整性。

3. **构造 ICMP 请求数据包 (`create_icmp_packet`)**:
   - ICMP 回显请求报文的类型码为 8。该函数创建一个 ICMP 回显请求报文，并包含了报头（类型、代码、校验和、标识符、序列号）和数据（当前时间戳）。
   - 校验和字段初始值为 0，然后通过 `calculate_checksum` 计算并重新填充 ICMP 数据包。

4. **发送 ICMP 请求数据包 (`send_one_ping`)**:
   - 创建并发送 ICMP Echo Request 数据包。该函数使用套接字 `sock.sendto` 将 ICMP 数据包发送到指定的目标地址。
   - 发送时使用了原始套接字 `socket.SOCK_RAW`，其协议类型为 `socket.IPPROTO_ICMP`，确保直接发送原始的 ICMP 数据包。

5. **接收 ICMP 回显应答 (`receive_one_ping`)**:
   - 等待接收 ICMP Echo Reply 报文，并计算发送和接收之间的延迟时间。
   - 该函数检查接收数据的长度，确保至少有 IP 报头（20 字节）和 ICMP 报头（8 字节），然后解析 ICMP 报头。
   - 使用收到的 ID 和类型来验证是否为回显应答报文（ICMP 类型 0）。
   - 如果是目标不可达报文（ICMP 类型 3）或超时报文（ICMP 类型 11），则输出对应的错误信息。
   - 计算往返时间（RTT，Round-Trip Time）并返回。

6. **单次 Ping 操作 (`do_one_ping`)**:
   - 该函数用于执行一次 ping 操作，首先创建原始套接字，然后调用 `send_one_ping` 发送 ICMP 请求报文，再调用 `receive_one_ping` 接收响应并计算延迟。
   - 返回往返时间或 `None`（如果超时或发生错误）。

7. **多次 Ping 和统计 (`ping`)**:
   - 该函数调用 `do_one_ping` 多次执行 ping 操作，并收集所有往返时间，最终计算最小、最大、平均延迟，并输出丢包率。
   - 函数循环执行 `count` 次 ping 操作，每次之间间隔 1 秒。
   - 最后输出统计信息，包括：
     - 发送的包数量
     - 收到的包数量
     - 丢失的包数量（通过 `count - len(rtt_list)` 计算）
     - 最小、最大、平均往返时间。

8. **命令行参数解析 (`argparse`)**:
   - 支持通过命令行参数动态指定目标主机（`host`）、ping 的次数（`count`）和每次 ping 的超时时间（`timeout`）。
   - 用户输入的命令行参数被传递给 `ping` 函数，执行相应的操作。

### 代码执行流程

1. **初始化**：
   - 程序启动后，通过 `argparse` 获取用户输入的命令行参数：目标主机、超时时间、ping 次数等。
   - 使用 `socket.gethostbyname` 获取目标主机的 IP 地址。

2. **发送 ICMP 请求**：
   - 程序循环 `count` 次，依次创建 ICMP Echo Request 报文，并发送到目标主机。
   - 每次发送后，程序等待响应，并计算往返时间。如果在指定的 `timeout` 内没有收到响应，则超时。

3. **接收 ICMP 响应**：
   - 接收来自目标主机的 ICMP Echo Reply 报文，并验证数据包的 ID 和类型是否正确。如果一切正常，则计算往返时间并记录下来。

4. **统计结果**：
   - 程序根据每次 ping 操作的结果，记录成功接收的数据包数量，计算丢包率，并输出每次 ping 的往返时间。
   - 最后，程序总结并输出最小、最大、平均延迟时间。

### 核心逻辑总结

- **发送与接收**：通过原始套接字 `SOCK_RAW` 发送 ICMP Echo Request，并等待 ICMP Echo Reply，计算网络延迟。
- **校验和**：ICMP 数据包必须经过校验和计算，确保数据的完整性。
- **数据包结构**：ICMP 数据包包括类型、代码、校验和、标识符、序列号等。接收的数据包还包含时间戳信息，用于计算延迟。
- **多次 ping 统计**：循环执行多次 ping 操作，收集统计数据（如最小、最大、平均 RTT）并输出。

### 附加功能

- **丢包率计算**：记录成功接收的响应包数量，计算丢包率。
- **处理 ICMP 错误代码**：处理目标不可达和 TTL 超时等错误。
- **用户自定义参数**：支持用户通过命令行参数指定目标地址、超时、ping 次数。

通过这段代码，你可以实现一个基本的 `ping` 工具，能够检测网络连接的延迟、丢包等情况。



